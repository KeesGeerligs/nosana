{"version":3,"file":"MigrateRouteAccessor.mjs","sources":["../../src/converters/MigrateRouteAccessor.ts"],"sourcesContent":["import { OpenApi } from \"../OpenApi\";\nimport { IHttpMigrateRoute } from \"../structures/IHttpMigrateRoute\";\nimport { Escaper } from \"../utils/Escaper\";\nimport { MapUtil } from \"../utils/MapUtil\";\nimport { StringUtil } from \"../utils/StringUtil\";\n\nexport namespace MigrateRouteAccessor {\n  export const overwrite = <\n    Schema extends OpenApi.IJsonSchema,\n    Operation extends OpenApi.IOperation<Schema>,\n  >(\n    routes: IHttpMigrateRoute<Schema, Operation>[],\n  ): void => {\n    const dict: Map<string, IElement<Schema, Operation>> = collect((op) =>\n      op.emendedPath\n        .split(\"/\")\n        .filter((str) => !!str.length && str[0] !== \":\")\n        .map(StringUtil.normalize)\n        .map((str) => (Escaper.variable(str) ? str : `_${str}`)),\n    )(routes) as Map<string, IElement<Schema, Operation>>;\n    for (const props of dict.values())\n      props.entries.forEach((entry, i) => {\n        entry.alias = StringUtil.escapeDuplicate(\n          [\n            ...props.children,\n            ...props.entries.filter((_, j) => i !== j).map((e) => e.alias),\n          ].map(StringUtil.normalize),\n        )(StringUtil.normalize(entry.alias));\n        entry.route.accessor = [...props.namespace, entry.alias];\n\n        const parameters: { name: string; key: string }[] = [\n          ...entry.route.parameters,\n          ...(entry.route.body ? [entry.route.body] : []),\n          ...(entry.route.headers ? [entry.route.headers] : []),\n          ...(entry.route.query ? [entry.route.query] : []),\n        ];\n        parameters.forEach(\n          (p, i) =>\n            (p.key = StringUtil.escapeDuplicate([\n              \"connection\",\n              entry.alias,\n              ...parameters.filter((_, j) => i !== j).map((y) => y.key),\n            ])(p.key)),\n        );\n      });\n  };\n\n  const collect =\n    <\n      Schema extends OpenApi.IJsonSchema,\n      Operation extends OpenApi.IOperation<Schema>,\n    >(\n      getter: (r: IHttpMigrateRoute<Schema, Operation>) => string[],\n    ) =>\n    (\n      routes: IHttpMigrateRoute<Schema, Operation>[],\n    ): Map<string, IElement<Schema, Operation>> => {\n      const dict: Map<string, IElement<Schema, Operation>> = new Map();\n      for (const r of routes) {\n        const namespace: string[] = getter(r);\n        let last: IElement<Schema, Operation> = MapUtil.take(dict)(\n          namespace.join(\".\"),\n        )(() => ({\n          namespace,\n          children: new Set(),\n          entries: [],\n        }));\n        last.entries.push({\n          route: r,\n          alias: getName(r),\n        });\n        namespace.slice(0, -1).forEach((_i, i, array) => {\n          const partial: string[] = namespace.slice(0, array.length - i);\n          const element: IElement<Schema, Operation> = MapUtil.take(dict)(\n            partial.join(\".\"),\n          )(() => ({\n            namespace: partial,\n            children: new Set(),\n            entries: [],\n          }));\n          element.children.add(last.namespace.at(-1)!);\n        });\n        const top = MapUtil.take(dict)(\"\")(() => ({\n          namespace: [],\n          children: new Set(),\n          entries: [],\n        }));\n        if (namespace.length) top.children.add(namespace[0]);\n      }\n      return dict;\n    };\n\n  const getName = <\n    Schema extends OpenApi.IJsonSchema,\n    Operation extends OpenApi.IOperation<Schema>,\n  >(\n    op: IHttpMigrateRoute<Schema, Operation>,\n  ): string => {\n    const method = op.method === \"delete\" ? \"erase\" : op.method;\n    if (op.parameters.length === 0) return method;\n    return (\n      method +\n      \"By\" +\n      op.parameters.map((p) => StringUtil.capitalize(p.key)).join(\"And\")\n    );\n  };\n\n  interface IElement<\n    Schema extends OpenApi.IJsonSchema,\n    Operation extends OpenApi.IOperation<Schema>,\n  > {\n    namespace: string[];\n    entries: IEntry<Schema, Operation>[];\n    children: Set<string>;\n  }\n  interface IEntry<\n    Schema extends OpenApi.IJsonSchema,\n    Operation extends OpenApi.IOperation<Schema>,\n  > {\n    route: IHttpMigrateRoute<Schema, Operation>;\n    alias: string;\n  }\n}\n"],"names":["MigrateRouteAccessor","overwrite","routes","dict","collect","op","emendedPath","split","filter","str","length","map","StringUtil","normalize","Escaper","variable","props","values","entries","forEach","entry","i","alias","escapeDuplicate","children","_","j","e","route","accessor","namespace","parameters","body","headers","query","p","key","y","getter","Map","r","last","MapUtil","take","join","Set","push","getName","slice","_i","array","partial","element","add","at","top","method","capitalize"],"mappings":";;;;;;AAMM,IAAWA;;CAAjB,SAAiBA;IACFA,qBAAAC,YAIXC;QAEA,MAAMC,OAAiDC,SAASC,MAC9DA,GAAGC,YACAC,MAAM,KACNC,QAAQC,SAAUA,IAAIC,UAAUD,IAAI,OAAO,MAC3CE,IAAIC,WAAWC,WACfF,KAAKF,OAASK,QAAQC,SAASN,OAAOA,MAAM,IAAIA,SALEL,CAMrDF;QACF,KAAK,MAAMc,SAASb,KAAKc,UACvBD,MAAME,QAAQC,SAAQ,CAACC,OAAOC;YAC5BD,MAAME,QAAQV,WAAWW,gBACvB,KACKP,MAAMQ,aACNR,MAAME,QAAQV,QAAO,CAACiB,GAAGC,MAAML,MAAMK,IAAGf,KAAKgB,KAAMA,EAAEL,UACxDX,IAAIC,WAAWC,WAJLD,CAKZA,WAAWC,UAAUO,MAAME;YAC7BF,MAAMQ,MAAMC,WAAW,KAAIb,MAAMc,WAAWV,MAAME;YAElD,MAAMS,aAA8C,KAC/CX,MAAMQ,MAAMG,eACXX,MAAMQ,MAAMI,OAAO,EAACZ,MAAMQ,MAAMI,SAAQ,OACxCZ,MAAMQ,MAAMK,UAAU,EAACb,MAAMQ,MAAMK,YAAW,OAC9Cb,MAAMQ,MAAMM,QAAQ,EAACd,MAAMQ,MAAMM,UAAS;YAEhDH,WAAWZ,SACT,CAACgB,GAAGd,MACDc,EAAEC,MAAMxB,WAAWW,gBAAgB,EAClC,cACAH,MAAME,UACHS,WAAWvB,QAAO,CAACiB,GAAGC,MAAML,MAAMK,IAAGf,KAAK0B,KAAMA,EAAED,QAH9CxB,CAINuB,EAAEC;AACR;AACD;IAGN,MAAMhC,UAKFkC,UAGApC;QAEA,MAAMC,OAAiD,IAAIoC;QAC3D,KAAK,MAAMC,KAAKtC,QAAQ;YACtB,MAAM4B,YAAsBQ,OAAOE;YACnC,IAAIC,OAAoCC,QAAQC,KAAKxC,KAAbuC,CACtCZ,UAAUc,KAAK,KADuBF,EAEtC,OAAO;gBACPZ;gBACAN,UAAU,IAAIqB;gBACd3B,SAAS;;YAEXuB,KAAKvB,QAAQ4B,KAAK;gBAChBlB,OAAOY;gBACPlB,OAAOyB,QAAQP;;YAEjBV,UAAUkB,MAAM,IAAI,GAAG7B,SAAQ,CAAC8B,IAAI5B,GAAG6B;gBACrC,MAAMC,UAAoBrB,UAAUkB,MAAM,GAAGE,MAAMxC,SAASW;gBAC5D,MAAM+B,UAAuCV,QAAQC,KAAKxC,KAAbuC,CAC3CS,QAAQP,KAAK,KAD8BF,EAE3C,OAAO;oBACPZ,WAAWqB;oBACX3B,UAAU,IAAIqB;oBACd3B,SAAS;;gBAEXkC,QAAQ5B,SAAS6B,IAAIZ,KAAKX,UAAUwB,IAAI;AAAI;YAE9C,MAAMC,MAAMb,QAAQC,KAAKxC,KAAbuC,CAAmB,GAAnBA,EAAuB,OAAO;gBACxCZ,WAAW;gBACXN,UAAU,IAAIqB;gBACd3B,SAAS;;YAEX,IAAIY,UAAUpB,QAAQ6C,IAAI/B,SAAS6B,IAAIvB,UAAU;AAClD;QACD,OAAO3B;AAAI;IAGf,MAAM4C,UAIJ1C;QAEA,MAAMmD,SAASnD,GAAGmD,WAAW,WAAW,UAAUnD,GAAGmD;QACrD,IAAInD,GAAG0B,WAAWrB,WAAW,GAAG,OAAO8C;QACvC,OACEA,SACA,OACAnD,GAAG0B,WAAWpB,KAAKwB,KAAMvB,WAAW6C,WAAWtB,EAAEC,OAAMQ,KAAK;AAC5D;AAkBL,EApHD,CAAiB5C,yBAAAA,uBAoHhB,CAAA;;"}