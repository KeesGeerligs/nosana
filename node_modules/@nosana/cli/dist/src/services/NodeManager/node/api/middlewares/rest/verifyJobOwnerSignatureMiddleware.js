import { PublicKey } from '@solana/web3.js';
import { getSDK } from '../../../../../sdk.js';
export async function verifyJobOwnerSignatureMiddleware(req, res, next) {
    const sdk = getSDK();
    const jobId = req.params.jobId;
    if (!jobId) {
        res.status(400).send('Expected jobId parameter.');
        return;
    }
    try {
        const job = await sdk.jobs.get(jobId);
        if (!job) {
            res.status(400).send(`Could not find job with id ${jobId}`);
            return;
        }
        if (!sdk.authorization.validateHeader(req.headers, {
            expiry: 300,
            key: 'x-session-id',
            publicKey: new PublicKey(job.project),
        })) {
            return res.status(401).send('Unathorized Request');
        }
        res.locals['session_id'] = req.headers['x-session-id'].split(':')[0];
        next();
    }
    catch (error) {
        res.status(401).send(`Unathorized Request: ${error.message}`);
    }
}
